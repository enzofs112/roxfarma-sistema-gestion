================================================================================
    CONFIGURACIÓN PARA MYSQL DE XAMPP - SISTEMA ROXFARMA
================================================================================

REQUISITOS PREVIOS:
------------------
1. Tener XAMPP instalado
2. Iniciar Apache y MySQL desde el panel de control de XAMPP
3. Verificar que MySQL esté corriendo en el puerto 3306

================================================================================
PASO 1: CREAR BASE DE DATOS EN XAMPP
================================================================================

1. Abrir phpMyAdmin:
   - Ir a http://localhost/phpmyadmin en el navegador
   - O hacer clic en "Admin" junto a MySQL en el panel de XAMPP

2. Crear la base de datos:
   - Clic en "Nueva" en el panel izquierdo
   - Nombre: roxfarma_db
   - Cotejamiento: utf8mb4_unicode_ci
   - Clic en "Crear"

3. Ejecutar el script SQL:
   - Seleccionar la base de datos "roxfarma_db"
   - Ir a la pestaña "SQL"
   - Copiar y pegar el siguiente script:

```sql
-- Crear base de datos (si no se creó desde phpMyAdmin)
CREATE DATABASE IF NOT EXISTS roxfarma_db
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

USE roxfarma_db;

-- Tabla Categoria
CREATE TABLE categoria (
    id_categoria BIGINT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion TEXT,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla Producto
CREATE TABLE producto (
    id_producto BIGINT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(200) NOT NULL,
    descripcion TEXT,
    precio DECIMAL(10, 2) NOT NULL,
    fecha_vencimiento DATE NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    id_categoria BIGINT NOT NULL,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (id_categoria) REFERENCES categoria(id_categoria),
    INDEX idx_stock (stock),
    INDEX idx_fecha_vencimiento (fecha_vencimiento)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla Proveedor
CREATE TABLE proveedor (
    id_proveedor BIGINT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(200) NOT NULL,
    contacto VARCHAR(100),
    direccion VARCHAR(255),
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla Cliente
CREATE TABLE cliente (
    id_cliente BIGINT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(200) NOT NULL,
    documento VARCHAR(20) NOT NULL UNIQUE,
    direccion VARCHAR(255),
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla Usuario
CREATE TABLE usuario (
    id_usuario BIGINT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    usuario VARCHAR(50) NOT NULL UNIQUE,
    contrasena VARCHAR(255) NOT NULL,
    rol ENUM('ADMINISTRADOR', 'TRABAJADOR') NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla Pedido
CREATE TABLE pedido (
    id_pedido BIGINT AUTO_INCREMENT PRIMARY KEY,
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    estado ENUM('PENDIENTE', 'ENVIADO', 'RECIBIDO') NOT NULL DEFAULT 'PENDIENTE',
    id_proveedor BIGINT NOT NULL,
    FOREIGN KEY (id_proveedor) REFERENCES proveedor(id_proveedor),
    INDEX idx_estado (estado)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla Detalle_Pedido
CREATE TABLE detalle_pedido (
    id_detalle_pedido BIGINT AUTO_INCREMENT PRIMARY KEY,
    id_pedido BIGINT NOT NULL,
    id_producto BIGINT NOT NULL,
    cantidad INT NOT NULL,
    FOREIGN KEY (id_pedido) REFERENCES pedido(id_pedido) ON DELETE CASCADE,
    FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla Venta
CREATE TABLE venta (
    id_venta BIGINT AUTO_INCREMENT PRIMARY KEY,
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    id_cliente BIGINT NOT NULL,
    id_usuario BIGINT NOT NULL,
    total DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (id_cliente) REFERENCES cliente(id_cliente),
    FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario),
    INDEX idx_fecha (fecha)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla Detalle_Venta
CREATE TABLE detalle_venta (
    id_detalle_venta BIGINT AUTO_INCREMENT PRIMARY KEY,
    id_venta BIGINT NOT NULL,
    id_producto BIGINT NOT NULL,
    cantidad INT NOT NULL,
    precio DECIMAL(10, 2) NOT NULL COMMENT 'Precio unitario al momento de la venta',
    FOREIGN KEY (id_venta) REFERENCES venta(id_venta) ON DELETE CASCADE,
    FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabla Auditoria
CREATE TABLE auditoria (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    operacion VARCHAR(50) NOT NULL,
    entidad VARCHAR(50) NOT NULL,
    id_entidad BIGINT,
    usuario VARCHAR(50) NOT NULL,
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    detalles TEXT,
    INDEX idx_fecha (fecha),
    INDEX idx_entidad (entidad, id_entidad)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Insertar datos iniciales
INSERT INTO categoria (nombre, descripcion) VALUES
('Analgésicos', 'Medicamentos para aliviar el dolor'),
('Antibióticos', 'Medicamentos para combatir infecciones bacterianas'),
('Antiinflamatorios', 'Medicamentos para reducir la inflamación'),
('Antipiréticos', 'Medicamentos para reducir la fiebre'),
('Vitaminas', 'Suplementos vitamínicos y minerales');

-- Insertar usuarios iniciales
-- Contraseña para ambos: password123
-- Hash generado con BCrypt (factor 12)
INSERT INTO usuario (nombre, usuario, contrasena, rol) VALUES
('Administrador Sistema', 'admin', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYIR.eLb4W6', 'ADMINISTRADOR'),
('Juan Pérez', 'jperez', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYIR.eLb4W6', 'TRABAJADOR');

-- Insertar algunos productos de ejemplo
INSERT INTO producto (nombre, descripcion, precio, fecha_vencimiento, stock, id_categoria) VALUES
('Paracetamol 500mg', 'Analgésico y antipirético', 15.50, '2025-12-31', 100, 1),
('Ibuprofeno 400mg', 'Antiinflamatorio no esteroideo', 22.00, '2025-11-30', 80, 3),
('Amoxicilina 500mg', 'Antibiótico de amplio espectro', 35.00, '2025-10-31', 50, 2),
('Vitamina C 1000mg', 'Suplemento vitamínico', 18.00, '2026-06-30', 120, 5);

-- Insertar algunos clientes de ejemplo
INSERT INTO cliente (nombre, documento, direccion) VALUES
('Farmacia San Juan', '20123456789', 'Av. Principal 123, Lima'),
('Botica Salud Total', '20987654321', 'Jr. Los Olivos 456, Lima'),
('Farmacia Central', '20456789123', 'Av. Arequipa 789, Lima');

-- Insertar algunos proveedores de ejemplo
INSERT INTO proveedor (nombre, contacto, direccion) VALUES
('Laboratorios Perú SAC', '(01) 234-5678', 'Av. Industrial 100, Lima'),
('Distribuidora Médica SA', '(01) 345-6789', 'Jr. Comercio 200, Lima'),
('Importadora Farma EIRL', '(01) 456-7890', 'Av. República 300, Lima');
```

4. Clic en "Continuar" para ejecutar el script

5. Verificar que las tablas se crearon correctamente:
   - En el panel izquierdo, expandir "roxfarma_db"
   - Deberías ver todas las tablas creadas

================================================================================
PASO 2: CONFIGURAR SPRING BOOT
================================================================================

Crear el archivo: src/main/resources/application.properties

```properties
# Configuración del servidor
server.port=8080

# Configuración de base de datos MySQL (XAMPP)
spring.datasource.url=jdbc:mysql://localhost:3306/roxfarma_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# Configuración JPA/Hibernate
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect

# Configuración JWT
jwt.secret=roxfarma_secret_key_2024_muy_segura_y_larga_para_produccion
jwt.expiration=86400000

# Configuración de logging
logging.level.com.roxfarma=DEBUG
logging.level.org.springframework.security=DEBUG
logging.file.name=logs/roxfarma.log

# Configuración de archivos
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB
```

NOTAS IMPORTANTES:
-----------------
1. spring.datasource.password está vacío (sin contraseña)
2. allowPublicKeyRetrieval=true es necesario para XAMPP
3. spring.jpa.hibernate.ddl-auto=update permite que Hibernate actualice el esquema automáticamente

================================================================================
PASO 3: VERIFICAR CONEXIÓN
================================================================================

1. Asegurarse de que MySQL esté corriendo en XAMPP
2. Ejecutar la aplicación Spring Boot
3. Verificar en los logs que la conexión sea exitosa:
   ```
   HikariPool-1 - Starting...
   HikariPool-1 - Start completed.
   ```

4. Si hay errores de conexión, verificar:
   - MySQL está corriendo en XAMPP
   - El puerto es 3306
   - La base de datos "roxfarma_db" existe
   - El usuario es "root" sin contraseña

================================================================================
CREDENCIALES DE ACCESO AL SISTEMA
================================================================================

ADMINISTRADOR:
- Usuario: admin
- Contraseña: password123
- Permisos: Acceso completo

TRABAJADOR:
- Usuario: jperez
- Contraseña: password123
- Permisos: Ventas, pedidos, inventario (solo lectura)

================================================================================
SOLUCIÓN DE PROBLEMAS COMUNES
================================================================================

PROBLEMA: "Access denied for user 'root'@'localhost'"
SOLUCIÓN: 
- Verificar que la contraseña esté vacía en application.properties
- En phpMyAdmin, ir a "Cuentas de usuario" y verificar que root no tenga contraseña

PROBLEMA: "Unknown database 'roxfarma_db'"
SOLUCIÓN:
- Crear la base de datos manualmente en phpMyAdmin
- Ejecutar el script SQL completo

PROBLEMA: "Communications link failure"
SOLUCIÓN:
- Verificar que MySQL esté corriendo en XAMPP
- Verificar que el puerto sea 3306
- Reiniciar MySQL desde el panel de XAMPP

PROBLEMA: "Public Key Retrieval is not allowed"
SOLUCIÓN:
- Agregar allowPublicKeyRetrieval=true a la URL de conexión

================================================================================
FIN DE LA CONFIGURACIÓN
================================================================================
